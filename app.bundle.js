!function(e){var t={};function s(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return e[a].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(a,i,function(t){return e[t]}.bind(null,i));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=1)}([function(e,t,s){},function(e,t,s){"use strict";s.r(t);s(0);function a(e,t){let s=[];for(let e=8;e<t*(t-1);e+=t)s.push(e);let a=[];for(let e=7;e<t*(t-1);e+=t)a.push(e);return 0===e?"top-left":e<t-1?"top":e===t-1?"top-right":-1!==s.indexOf(e)?"left":-1!==a.indexOf(e)?"right":e===t*(t-1)?"bottom-left":e===t*t-1?"bottom-right":e>t*(t-1)?"bottom":"center"}class r{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.tooltip=null,this.blocker=null}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener("click",e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener("click",e=>this.onLoadGameClick(e)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile",`map-tile-${a(e,this.boardSize)}`),t.addEventListener("mouseenter",e=>this.onCellEnter(e)),t.addEventListener("mouseleave",e=>this.onCellLeave(e)),t.addEventListener("click",e=>this.onCellClick(e)),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children),this.createTooltip(),this.createBlocker()}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator",`health-level-indicator-${t=s.character.health,t<15?"critical":t<50?"normal":"high"}`),r.style.width=`${s.character.health}%`,i.appendChild(r),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith("selected")))}createTooltip(){this.tooltip=document.createElement("div"),this.tooltip.classList.add("tooltip"),this.tooltip.classList.add("hidden"),document.body.append(this.tooltip)}showCellTooltip(e,t){this.tooltip.innerHTML=e,this.tooltip.classList.remove("hidden"),this.tooltip.style.left=window.event.clientX+5+"px",this.tooltip.style.top=window.event.clientY+5+"px"}hideCellTooltip(e){this.tooltip.innerHTML="",this.tooltip.classList.add("hidden")}showDamage(e,t){return new Promise(s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",()=>{a.removeChild(i),s()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}createBlocker(){this.blocker=document.createElement("div"),this.blocker.classList.add("blocker"),this.blocker.classList.add("hidden"),document.body.append(this.blocker)}}class l{constructor(e,t="generic"){this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t}levelUp(){this.level+=1,this.attack=Math.round(Math.max(this.attack,this.attack*(1.8-(100-this.health)/100))),this.defence=Math.round(Math.max(this.defence,this.defence*(1.8-(100-this.health)/100))),this.health=10*this.level+80,this.health>100&&(this.health=100)}}class n{constructor(e,t){if(!(e instanceof l))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function h(e,t){let s=Math.floor(Math.random()*e.length),a=Math.floor(Math.random()*t+1);const[r,l]=function(e){let t=[],s=[];for(let s=0;s<e*e;s+=e)t.push(s);for(let s=1;s<e*e;s+=e)t.push(s);for(let t=e-1;t<e*e;t+=e)s.push(t);for(let t=e-2;t<e*e;t+=e)s.push(t);return[t,s]}(8),h=new e[s](1);if(a>1)for(i=0;i<a-1;i++)h.levelUp();let o=[];o="Bowman"===h.type||"Magician"===h.type||"Swordsman"===h.type?r:l;let c=o[Math.floor(Math.random()*o.length)];return new n(h,c)}function o(e,t,s){const a=[];for(let i=0;i<s;i++){const s=h(e,t);a.push(s)}return a}function c(e,t){let s=e+Math.random()*(t+1-e);return Math.floor(s)}class d{constructor(e){this.boardSize=e,this.boardIndexes=this.makeIndexes(),this.boardArray=this.makeArray()}makeIndexes(){const e=[];for(let t=0;t<this.boardSize**2;t++)e.push(t);return e}makeArray(){let e=[];for(let t=0;t<this.boardIndexes.length;t+=this.boardSize)e.push(this.boardIndexes.slice(t,t+this.boardSize));return e}coordinates(e){let t=0;return 0!=e&&(t=this.boardArray.findIndex(t=>t.find(t=>t===e))),[this.boardArray[t].findIndex(t=>t===e),t]}calculateArea(e,t){const s=[],[a,i]=this.coordinates(t);for(let t=i-e;t<=i+e;t++)if(t>=0&&t<this.boardSize)for(let i=a-e;i<=a+e;i++)i>=0&&i<this.boardSize&&s.push(this.boardArray[t][i]);return s.splice(s.indexOf(t),1),s}calculateAreaMove(e,t){let s=[];const[a,i]=this.coordinates(t);for(let t=i-e;t<=i+e;t++)t>=0&&t<this.boardSize&&s.push(this.boardArray[t][a]);for(let t=a-e;t<=a+e;t++)t>=0&&t<this.boardSize&&s.push(this.boardArray[i][t]);for(let t=0;t<=2*e;t++){let r=i-e+t;r>=0&&r<this.boardSize&&(s.push(this.boardArray[r][a-e+t]),s.push(this.boardArray[r][a+e-t]))}return s=s.filter(e=>void 0!==e),s=[...new Set(s)],s}}class u extends l{constructor(e){super(e,"Bowman"),this.attack=25,this.defence=25,this.health=100,this.distanceAttack=2,this.distanceMove=2}}class m extends l{constructor(e){super(e,"Daemon"),this.attack=10,this.defence=40,this.health=100,this.distanceAttack=4,this.distanceMove=1}}class y extends l{constructor(e){super(e,"Magician"),this.attack=10,this.defence=40,this.health=100,this.distanceAttack=4,this.distanceMove=1}}class p extends l{constructor(e){super(e,"Swordsman"),this.attack=40,this.defence=10,this.health=100,this.distanceAttack=1,this.distanceMove=4}}class C extends l{constructor(e){super(e,"Undead"),this.attack=25,this.defence=25,this.health=100,this.distanceAttack=1,this.distanceMove=4}}class f extends l{constructor(e){super(e,"Vampire"),this.attack=40,this.defence=10,this.health=100,this.distanceAttack=2,this.distanceMove=2}}var v={level:'<img style="height: 12px;" src="./src/img/icons/military-medal-emoji-by-google.png">',attack:'<img style="height: 12px;" src="./src/img/icons/crossed-swords-emoji-by-google.png">',defence:'<img style="height: 12px;" src="./src/img/icons/shield-emoji-by-google.png">',health:'<img style="height: 12px;" src="./src/img/icons/heart-emoji-by-google.png">'};var g={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class L{constructor(e,t){this.gamePlay=e,this.board=new d(this.gamePlay.boardSize),this.stateService=t,this.onCellEnter=this.onCellEnter.bind(this),this.onCellLeave=this.onCellLeave.bind(this),this.onCellClick=this.onCellClick.bind(this),this.playerChars=[],this.enemyChars=[],this.allChars=[],this.currentChar=null,this.currentEnemy=null,this.canMove=!1,this.canAttack=!1,this.isPlayerTurn=!0,this.currentLevel=1}init(){this.gamePlay.drawUi(g.prairie),this.addListeners(),this.gamePlay.redrawPositions(this.startNewGame()),this.currentChar=null,this.currentEnemy=null,this.isPlayerTurn=!0,this.currentLevel=1}addListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter),this.gamePlay.addCellLeaveListener(this.onCellLeave),this.gamePlay.addCellClickListener(this.onCellClick),this.gamePlay.addNewGameListener(()=>this.init())}static checkChar(e,t=[]){for(let s of t)if(e.classList.contains(s))return!0}defineCurrentChar(e){this.currentChar=this.playerChars.filter(t=>t.position===e)[0],this.calculateActionArea(this.currentChar)}defineCurrentEnemy(e){this.currentEnemy=this.enemyChars.filter(t=>t.position===e)[0],this.calculateActionArea(this.currentEnemy)}calculateActionArea(e){e.areaMove=this.board.calculateAreaMove(e.character.distanceMove,e.position),e.areaAttack=this.board.calculateArea(e.character.distanceAttack,e.position)}selectChar(e){this.gamePlay.selectCell(e),this.defineCurrentChar(e)}setAction(e,t){this.canMove=e,this.canAttack=t}movePlayerChar(e,t){this.gamePlay.deselectCell(e.position),e.position=t,this.gamePlay.redrawPositions(this.allChars),this.selectChar(t),this.isPlayerTurn=!1,this.enemyTurn()}moveEnemyChar(e){const t=c(0,this.currentEnemy.areaMove.length-1),s=this.currentEnemy.areaMove[t];e.position=s,this.gamePlay.redrawPositions(this.allChars)}async enemyTurn(){this.setBlocker(!0);setTimeout(()=>{const e=c(0,this.enemyChars.length-1);this.defineCurrentEnemy(this.enemyChars[e].position);let t=(()=>{let e=null;return this.currentEnemy.areaAttack.forEach(t=>{const s=this.playerChars.filter(e=>e.position===t);s.length>0&&(e=s)}),e})();t?this.attack(this.currentEnemy,t[0]):this.moveEnemyChar(this.currentEnemy),this.isPlayerTurn=!0,this.setBlocker(!1)},1e3)}async attack(e,t){let s=Math.floor(Math.max(e.character.attack-t.character.defence,.1*e.character.attack));await this.gamePlay.showDamage(t.position,s),t.character.health-=s,t.character.health<=0&&this.killChar(t),this.gamePlay.redrawPositions(this.allChars)}killChar(e){this.playerChars=this.playerChars.filter(t=>t!=e),this.enemyChars=this.enemyChars.filter(t=>t!=e),this.allChars=this.allChars.filter(t=>t!=e),this.checkFinishLevel()}checkFinishLevel(){console.log(this.currentLevel),0===this.playerChars.length?this.gameOver():0===this.enemyChars.length&&(this.currentLevel<4?(this.currentLevel+=1,this.startNewLevel(this.currentLevel)):this.win())}async onCellClick(e){const t=event.target,s=t&&L.checkChar(t,["Bowman","Swordsman","Magician"]);if(L.checkChar(t,["Undead","Vampire","Daemon"]))if(this.canAttack){const t=this.enemyChars.filter(t=>t.position===e)[0];await this.attack(this.currentChar,t),await this.enemyTurn()}else r.showError("This is an enemy character!");else s?(this.currentChar&&this.gamePlay.deselectCell(this.currentChar.position),this.selectChar(e)):this.currentChar&&this.canMove&&this.movePlayerChar(this.currentChar,e)}onCellEnter(e){const t=event.target.querySelector(".character");if(t){const s=this.allChars.filter(t=>t.position===e)[0].character,a=`${v.level} ${s.level} ${v.attack} ${s.attack} ${v.defence} ${s.defence} ${v.health} ${s.health}`;this.gamePlay.showCellTooltip(a,e),L.checkChar(t,["Bowman","Swordsman","Magician"])?(this.gamePlay.setCursor("pointer"),this.setAction(!1,!1)):null!==this.currentChar&&-1!==this.currentChar.areaAttack.indexOf(e)&&(this.gamePlay.setCursor("crosshair"),this.gamePlay.selectCell(e,"red"),this.setAction(!1,!0))}else null!==this.currentChar&&-1!==this.currentChar.areaMove.indexOf(e)?(this.gamePlay.setCursor("pointer"),this.gamePlay.selectCell(e,"green"),this.setAction(!0,!1)):(this.gamePlay.setCursor("not-allowed"),this.setAction(!1,!1))}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor("auto"),(this.gamePlay.cells[e].classList.contains("selected-green")||this.gamePlay.cells[e].classList.contains("selected-red"))&&this.gamePlay.deselectCell(e)}gameOver(){alert("Game over!")}win(){alert("Win")}startNewGame(){return this.playerChars=o([p,u],1,2),this.enemyChars=o([m,C,f],1,2),this.allChars=this.playerChars.concat(this.enemyChars),this.allChars}startSecondLevel(){this.gamePlay.drawUi(g.desert);let e=o([p,u,y],1,1);this.playerChars=this.playerChars.concat(e),this.enemyChars=o([m,C,f],2,this.playerChars.length),this.allChars=this.playerChars.concat(this.enemyChars)}startThirdLevel(){this.gamePlay.drawUi(g.arctic);let e=o([p,u,y],2,2);this.playerChars=this.playerChars.concat(e),this.enemyChars=o([m,C,f],2,this.playerChars.length),this.allChars=this.playerChars.concat(this.enemyChars)}startFourthLevel(){this.gamePlay.drawUi(g.mountain);let e=o([p,u,y],3,2);this.playerChars=this.playerChars.concat(e),this.enemyChars=o([m,C,f],4,this.playerChars.length),this.allChars=this.playerChars.concat(this.enemyChars)}restoreHealth(){this.playerChars.forEach(e=>e.character.health=100)}setBlocker(e){e?this.gamePlay.blocker.classList.remove("hidden"):this.gamePlay.blocker.classList.add("hidden")}startNewLevel(e){switch(e){case 2:this.startSecondLevel();break;case 3:this.startThirdLevel();break;case 4:this.startFourthLevel()}this.restoreHealth(),this.gamePlay.redrawPositions(this.allChars)}}const b=new r;b.bindToDOM(document.querySelector("#game-container"));const k=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new L(b,k).init()}]);